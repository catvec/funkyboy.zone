#!/usr/sbin/nft -f

# Clear existing rules
flush ruleset

# Main firewall table
table inet filter {
  chain input {
    type filter hook input priority filter; policy drop;
    
    # Allow loopback
    iif lo accept
    
    # Drop invalid packets
    ct state invalid drop
    
    # Allow established/related connections
    ct state established,related accept
    
    # Allow SSH with per-IP rate limiting (3 attempts per minute per IP)
    tcp dport {{ pillar.ssh.port }} ct state new meter ssh_meter { ip saddr limit rate 3/minute } accept
    
    # Allow ICMP ping with rate limiting per IP
    ip protocol icmp icmp type echo-request meter icmp_meter { ip saddr limit rate 5/second } accept
    ip6 nexthdr icmpv6 icmpv6 type echo-request meter icmp6_meter { ip6 saddr limit rate 5/second } accept
    
    # Log dropped packets before dropping
    log prefix "nft-input-drop: " drop
  }
  
  chain forward {
    type filter hook forward priority filter; policy drop;
  }
  
  chain output {
    type filter hook output priority filter; policy accept;
  }
}