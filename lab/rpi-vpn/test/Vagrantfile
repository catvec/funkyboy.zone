# -*- mode: ruby -*-
# vi: set ft=ruby :

# Load IP configuration from environment file
require 'dotenv'
Dotenv.load('vm-config.env')

Vagrant.configure("2") do |config|
  # Use Debian bookworm to match our Docker setup
  config.vm.box = "debian/bookworm64"
  
  # Disable automatic box update checking
  config.vm.box_check_update = false

  # RPI-VPN VM (target for Salt configuration)
  config.vm.define "rpi-vpn" do |vm|
    vm.vm.hostname = "rpi-vpn"
    vm.vm.network "private_network", ip: ENV['RPI_VPN_PRIVATE_IP']
    vm.vm.network "private_network", ip: ENV['RPI_VPN_PUBLIC_IP']

    # Mount the entire repo (equivalent to Docker volume mount)
    vm.vm.synced_folder "../../..", "/repo", type: "virtualbox"

    vm.vm.provider "virtualbox" do |vb|
      vb.name = "salt-test-rpi-vpn"
      vb.memory = "512"
      vb.cpus = 1
    end
    
    vm.vm.provision "shell", path: "provision/rpi-vpn.sh"
  end

  # External server VM (for NAT testing)
  config.vm.define "external" do |vm|
    vm.vm.hostname = "external-server"
    vm.vm.network "private_network", ip: ENV['EXTERNAL_SERVER_IP']
    
    vm.vm.provider "virtualbox" do |vb|
      vb.name = "salt-test-external"
      vb.memory = "256"
      vb.cpus = 1
    end
    
    vm.vm.provision "shell", path: "provision/external.sh"
  end

  # Orchestrator VM (runs Salt SSH and tests)
  config.vm.define "orchestrator" do |vm|
    vm.vm.hostname = "salt-orchestrator"
    vm.vm.network "private_network", ip: ENV['ORCHESTRATOR_PRIVATE_IP']
    # Removed direct external network access - must use VPN to reach external server
    
    vm.vm.provider "virtualbox" do |vb|
      vb.name = "salt-test-orchestrator"
      vb.memory = "1024"
      vb.cpus = 2
    end
    
    # Mount the entire repo (equivalent to Docker volume mount)
    vm.vm.synced_folder "../../..", "/repo", type: "virtualbox"
    
    vm.vm.provision "shell", path: "provision/orchestrator.sh"
  end
end
